<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ambar - Games</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style/tool.css">
    <link rel="stylesheet" href="style/game.css">

</head>
<body>
    <div class="main-content">
        <div class="games-header">
            <h1 class="games-title">Games Arena</h1>
            <p class="games-subtitle">Play games to earn coins and improve your stats</p>
        </div>

        <div class="game-categories">
            <div class="game-category luck-games" onclick="openGameModal('luck')">
                <div class="category-icon">
                    <i class="fas fa-dice"></i>
                </div>
                <h2 class="category-title">Luck Games</h2>
                <p class="category-description">Test your fortune and earn coins based on chance</p>
                <div class="category-stats">
                    <div class="stat-item">
                        <span class="stat-value" id="luck-percentage">0%</span>
                        <span class="stat-label">Luck Rate</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value" id="luck-games-played">0</span>
                        <span class="stat-label">Games</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value" id="luck-coins-earned">0</span>
                        <span class="stat-label">Coins</span>
                    </div>
                </div>
                <button class="play-button">Play Luck Games</button>
            </div>

            <div class="game-category level-games" onclick="openGameModal('level')">
                <div class="category-icon">
                    <i class="fas fa-trophy"></i>
                </div>
                <h2 class="category-title">Level Games</h2>
                <p class="category-description">Progress through challenging levels and unlock achievements</p>
                <div class="category-stats">
                    <div class="stat-item">
                        <span class="stat-value" id="levels-crossed">0</span>
                        <span class="stat-label">Levels</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value" id="level-games-played">0</span>
                        <span class="stat-label">Games</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value" id="level-coins-earned">0</span>
                        <span class="stat-label">Coins</span>
                    </div>
                </div>
                <button class="play-button">Play Level Games</button>
            </div>

            <div class="game-category knowledge-games"  onclick="window.location.href='knowledge.html'">
                <div class="category-icon">
                    <i class="fas fa-brain"></i>
                </div>
                <h2 class="category-title">Knowledge Games</h2>
                <p class="category-description">Challenge your mind with quizzes and trivia</p>
                <div class="category-stats">
                    <div class="stat-item">
                        <span class="stat-value" id="knowledge-marks">0</span>
                        <span class="stat-label">Marks</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value" id="knowledge-games-played">0</span>
                        <span class="stat-label">Games</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value" id="knowledge-coins-earned">0</span>
                        <span class="stat-label">Coins</span>
                    </div>
                </div>
                <button class="play-button">Play Knowledge Games</button>
            </div>
        </div>

        <div class="tasks-section">
            <h3 class="tasks-title">Earn More Coins</h3>
            <button class="task-button" onclick="window.location.href='task.html'">
                <i class="fas fa-tasks"></i>
                Complete Tasks
            </button>
        </div>
    </div>

    <div class="game-modal" id="gameModal">
        <div class="modal-content">
            <h2 class="modal-title" id="modalTitle">Select a Game</h2>
            <div class="game-list" id="gameList"></div>
            <button class="close-modal" onclick="closeGameModal()">Close</button>
        </div>
    </div>
<script src="config.js"></script>
    <script src="tool.js"></script>
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
        import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js';
        import { getFirestore, doc, getDoc, updateDoc, serverTimestamp, onSnapshot } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js';

const firebaseConfig = window.CONFIG.firebase;

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let userData = null;
        let partnerData = null;
        let gameStatsSyncTimer = null;

        const gameData = {
            luck: [
                { name: 'Coin Spin', icon: 'fas fa-coins', desc: 'Spin coins and match the computer', coins: '10-500', available: true, url: 'coin.html' },
                { name: 'Dice Roll', icon: 'fas fa-dice-six', desc: 'Roll dice and predict the outcome', coins: '5-300', available: true, url: 'dice.html' },
                { name: 'Lucky Wheel', icon: 'fas fa-circle-notch', desc: 'Spin the wheel of fortune', coins: '20-1000', available: true, url: 'wheel.html' },
                { name: 'Card Draw', icon: 'fas fa-playing-card', desc: 'Draw cards and beat the dealer', coins: '15-400', available: true, url: 'card.html'}
            ],
            level: [
                { name: 'Runner Game', icon: 'fas fa-running', desc: 'Jump and run through obstacles', coins: '50-200', available: true, url: 'run.html' },
                { name: 'Puzzle Master', icon: 'fas fa-puzzle-piece', desc: 'Solve increasingly difficult puzzles', coins: '30-150', available: true, url: 'puzzle.html' },
                { name: 'Memory Match', icon: 'fas fa-brain', desc: 'Match pairs in limited time', coins: '25-120', available: true , url: 'pairs.html'},
                { name: 'Speed Clicker', icon: 'fas fa-mouse-pointer', desc: 'Click targets as fast as you can', coins: '40-180', available: true , url: 'clicker.html'}
            ]
        };

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                loadUserData();
            } else {
                window.location.href = 'index.html';
            }
        });

        async function loadUserData() {
            try {
                const userDoc = await getDoc(doc(db, 'users', currentUser.uid));
                if (userDoc.exists()) {
                    userData = userDoc.data();
                    setupDataListeners();
                    await loadPartnerData();
                    loadGameStats();
                    updateCurrencyDisplay();
                    checkForNotifications();
                }
            } catch (error) {
                console.error('Error loading user data:', error);
            }
        }

        async function loadPartnerData() {
            if (userData?.partnerId) {
                try {
                    const partnerDoc = await getDoc(doc(db, 'users', userData.partnerId));
                    if (partnerDoc.exists()) {
                        partnerData = partnerDoc.data();
                    }
                } catch (error) {
                    console.error('Error loading partner data:', error);
                }
            }
        }

        function setupDataListeners() {
            const userRef = doc(db, 'users', currentUser.uid);
            onSnapshot(userRef, (docSnap) => {
                if (docSnap.exists()) {
                    const newUserData = docSnap.data();
                    const oldGiftCount = userData?.receivedGifts?.length || 0;
                    const newGiftCount = newUserData?.receivedGifts?.length || 0;
                    
                    userData = newUserData;
                    
                    if (newGiftCount > oldGiftCount) {
                        const latestGift = newUserData.receivedGifts[newGiftCount - 1];
                        showGiftNotification(latestGift);
                    }
                    
                    loadGameStats();
                    updateCurrencyDisplay();
                }
            });
        }

        function checkForNotifications() {
            if (userData?.lastMessageTime && userData?.lastReadTime && 
                userData.lastMessageTime.toMillis() > (userData.lastReadTime?.toMillis() || 0)) {
                const lastMessage = userData.lastMessage || "New message received";
                showMessageNotification(lastMessage);
            }
        }

        function showGiftNotification(gift) {
            showNotification(`New gift received: ${gift.category}`, 'gift', () => {
                window.location.href = 'line.html';
            });
        }

        function showMessageNotification(messageText) {
            const text = messageText.length > 30 ? messageText.substring(0, 30) + '...' : messageText;
            showNotification(text, 'message', () => {
                window.location.href = 'line.html';
            });
        }

        function showNotification(message, type = 'success', onclick = null) {
            const notification = document.createElement('div');
            notification.className = `notification ${type} show`;
            notification.textContent = message;
            
            if (onclick) {
                notification.style.cursor = 'pointer';
                notification.addEventListener('click', onclick);
            }
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => document.body.removeChild(notification), 300);
            }, 5000);
        }

        function getLiveStats() {
            return {
                totalWinRate: parseInt(localStorage.getItem('totalWinRate')) || 0,
                luckGamesPlayed: parseInt(localStorage.getItem('luckGamesPlayed')) || 0,
                luckCoinsEarned: parseInt(localStorage.getItem('luckCoinsEarned')) || 0,
                levelsCrossed: parseInt(localStorage.getItem('levelsCrossed')) || 0,
                levelGamesPlayed: parseInt(localStorage.getItem('levelGamesPlayed')) || 0,
                levelCoinsEarned: parseInt(localStorage.getItem('levelCoinsEarned')) || 0,
                knowledgeMarks: parseInt(localStorage.getItem('knowledgeMarks')) || 0,
                knowledgeGamesPlayed: parseInt(localStorage.getItem('knowledgeGamesPlayed')) || 0,
                knowledgeCoinsEarned: parseInt(localStorage.getItem('knowledgeCoinsEarned')) || 0,
                coins: parseInt(localStorage.getItem('coins')) || 0,
                stars: parseInt(localStorage.getItem('stars')) || 0,
                hearts: parseInt(localStorage.getItem('hearts')) || 0,
                luck: parseInt(localStorage.getItem('luck')) || 0,
                level: parseInt(localStorage.getItem('level')) || 1
            };
        }

        function loadGameStats() {
            const stats = getLiveStats();
            
            // Update UI elements
            document.getElementById('luck-percentage').textContent = stats.totalWinRate + '%';
            document.getElementById('luck-games-played').textContent = stats.luckGamesPlayed.toLocaleString();
            document.getElementById('luck-coins-earned').textContent = stats.luckCoinsEarned.toLocaleString();
            
            document.getElementById('levels-crossed').textContent = stats.levelsCrossed.toLocaleString();
            document.getElementById('level-games-played').textContent = stats.levelGamesPlayed.toLocaleString();
            document.getElementById('level-coins-earned').textContent = stats.levelCoinsEarned.toLocaleString();
            
            document.getElementById('knowledge-marks').textContent = stats.knowledgeMarks.toLocaleString();
            document.getElementById('knowledge-games-played').textContent = stats.knowledgeGamesPlayed.toLocaleString();
            document.getElementById('knowledge-coins-earned').textContent = stats.knowledgeCoinsEarned.toLocaleString();
        }

        function updateCurrencyDisplay() {
            const stats = getLiveStats();
            if (window.AmbarHeader && window.AmbarHeader.setCurrency) {
                window.AmbarHeader.setCurrency('coins', stats.coins);
                window.AmbarHeader.setCurrency('stars', stats.stars);
                window.AmbarHeader.setCurrency('hearts', stats.hearts);
            }
        }

        function openGameModal(category) {
            const modal = document.getElementById('gameModal');
            const modalTitle = document.getElementById('modalTitle');
            const gameList = document.getElementById('gameList');
            
            const titles = { luck: 'Luck Games', level: 'Level Games', knowledge: 'Knowledge Games' };
            modalTitle.textContent = titles[category] || 'Games';
            
            gameList.innerHTML = '';
            const games = gameData[category] || [];
            
            games.forEach(game => {
                const gameItem = document.createElement('div');
                gameItem.className = `game-item ${game.available ? 'available' : 'coming-soon'}`;
                
                gameItem.innerHTML = `
                    <div class="game-icon">
                        <i class="${game.icon}"></i>
                    </div>
                    <div class="game-info">
                        <div class="game-name">
                            ${game.name}
                            <span class="game-status ${game.available ? 'status-available' : 'status-coming-soon'}">
                                ${game.available ? 'Available' : 'Coming Soon'}
                            </span>
                        </div>
                        <div class="game-desc">${game.desc}</div>
                        <div class="game-desc">Coins: ${game.coins}</div>
                    </div>
                `;
                
                if (game.available && game.url) {
                    gameItem.addEventListener('click', () => {
                        window.location.href = game.url;
                    });
                } else if (!game.available) {
                    gameItem.addEventListener('click', () => {
                        showNotification(`${game.name} is coming soon!`, 'error');
                    });
                }
                
                gameList.appendChild(gameItem);
            });
            
            modal.style.display = 'flex';
        }

        function closeGameModal() {
            document.getElementById('gameModal').style.display = 'none';
        }

        // Global functions
        window.openGameModal = openGameModal;
        window.closeGameModal = closeGameModal;

        // Event listeners
        document.addEventListener('DOMContentLoaded', () => {
            if (window.AmbarHeader) {
                window.AmbarHeader.init({
                    showCurrencies: ['coins', 'stars', 'hearts'],
                    showSettings: false,
                    showBackButton: false
                });
            }
            
            if (window.AmbarNavigation) {
                window.AmbarNavigation.setActivePage('games');
            }
            
            // Close modal when clicking outside
            document.getElementById('gameModal').addEventListener('click', (e) => {
                if (e.target.id === 'gameModal') closeGameModal();
            });
            
        let lastStats = {};

        setInterval(() => {
            const stats = getLiveStats();
            if (JSON.stringify(stats) !== JSON.stringify(lastStats)) {
                loadGameStats();
                updateCurrencyDisplay();
                lastStats = stats;
            }
        }, 2000);

        });

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeGameModal();
            if (e.key >= '1' && e.key <= '3' && !document.getElementById('gameModal').style.display) {
                const categories = ['luck', 'level', 'knowledge'];
                openGameModal(categories[parseInt(e.key) - 1]);
            }
        });

        // Game stats API
        window.GameStatsAPI = {
            updateLuckStats: function(gamesPlayed, coinsEarned, winPercentage) {
                const currentGames = parseInt(localStorage.getItem('luckGamesPlayed')) || 0;
                const currentCoins = parseInt(localStorage.getItem('luckCoinsEarned')) || 0;
                const currentWinRate = parseFloat(localStorage.getItem('totalWinRate')) || 0;
                
                const newGamesPlayed = currentGames + gamesPlayed;
                const newCoinsEarned = currentCoins + coinsEarned;
                const newWinRate = newGamesPlayed > 0 ? 
                    ((currentWinRate * currentGames) + (winPercentage * gamesPlayed)) / newGamesPlayed : 0;
                
                localStorage.setItem('luckGamesPlayed', newGamesPlayed.toString());
                localStorage.setItem('luckCoinsEarned', newCoinsEarned.toString());
                localStorage.setItem('totalWinRate', newWinRate.toString());
                localStorage.setItem('luck', Math.round(newWinRate).toString());
                
                const currentCoinsTotal = parseInt(localStorage.getItem('coins')) || 0;
                localStorage.setItem('coins', (currentCoinsTotal + coinsEarned).toString());
            },
            
            updateKnowledgeStats: function(marksEarned, gamesPlayed, coinsEarned) {
                const currentMarks = parseInt(localStorage.getItem('knowledgeMarks')) || 0;
                const currentGames = parseInt(localStorage.getItem('knowledgeGamesPlayed')) || 0;
                const currentCoins = parseInt(localStorage.getItem('knowledgeCoinsEarned')) || 0;
                const currentCoinsTotal = parseInt(localStorage.getItem('coins')) || 0;
                
                localStorage.setItem('knowledgeMarks', (currentMarks + marksEarned).toString());
                localStorage.setItem('knowledgeGamesPlayed', (currentGames + gamesPlayed).toString());
                localStorage.setItem('knowledgeCoinsEarned', (currentCoins + coinsEarned).toString());
                localStorage.setItem('coins', (currentCoinsTotal + coinsEarned).toString());
            },
            
            getCurrentStats: function() {
                return getLiveStats();
            }
        };
    </script>
</body>
</html>