<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ambar - Find Partner</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style/add.css">
</head>
<body>
    <div class="header">
        <div class="logo">Ambar</div>
        <div>
            <a href="bot.html" class="nav-btn"><i class="fas fa-user"></i> Rendom Rartner</a>
            <a href="home.html" class="nav-btn"><i class="fas fa-forward"></i> Skip for now</a>
        </div>
    </div>

    <div class="main-content">
        <div class="search-container">
            <div class="search-option email" onclick="openEmailSearch()">
                <div class="option-header">
                    <div class="option-icon"><i class="fas fa-envelope"></i></div>
                    <div>
                        <div class="option-title">Search by Email</div>
                        <div class="option-subtitle">Find someone you know</div>
                    </div>
                </div>
                <div class="option-description">
                    Enter your friend's email address to send them a partner request.
                </div>
            </div>

            <div class="search-option invite" onclick="generateInviteLink()">
                <div class="option-header">
                    <div class="option-icon"><i class="fas fa-link"></i></div>
                    <div>
                        <div class="option-title">Invite through Link</div>
                        <div class="option-subtitle">Share your unique link</div>
                    </div>
                </div>
                <div class="option-description">
                    Create a special invite link to share with anyone.
                </div>
            </div>

            <div class="incoming-requests">
                <div class="requests-header">
                    <div class="requests-icon"><i class="fas fa-user-friends"></i></div>
                    <div class="requests-title">Incoming Requests</div>
                    <div class="request-count" id="requestCount">0</div>
                </div>
                <div id="requestsList">
                    <div class="no-requests">No pending requests</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Email Search Modal -->
    <div class="modal" id="emailModal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal('emailModal')"><i class="fas fa-times"></i></button>
            <div class="modal-header">
                <div class="modal-title">Search by Email</div>
                <div class="modal-subtitle">Find your friend on Ambar</div>
            </div>
            <div class="form-group">
                <label class="form-label">Email Address</label>
                <input type="email" class="form-input" id="searchEmail" placeholder="Enter friend's email">
            </div>
            <div class="modal-actions">
                <button class="modal-btn secondary" onclick="closeModal('emailModal')">Cancel</button>
                <button class="modal-btn primary" id="searchBtn" onclick="searchByEmail()">
                    <i class="fas fa-search"></i> Send Request
                </button>
            </div>
        </div>
    </div>

    <!-- Invite Link Modal -->
    <div class="modal" id="inviteLinkModal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal('inviteLinkModal')"><i class="fas fa-times"></i></button>
            <div class="modal-header">
                <div class="modal-title">Your Invite Link</div>
                <div class="modal-subtitle">Share this link with anyone</div>
            </div>
            <div class="invite-link-container">
                <div class="invite-link" id="generatedLink"></div>
                <button class="copy-btn" onclick="copyInviteLink()"><i class="fas fa-copy"></i> Copy Link</button>
            </div>
            <div class="modal-actions">
                <button class="modal-btn secondary" onclick="closeModal('inviteLinkModal')">Close</button>
                <button class="modal-btn primary" onclick="shareInviteLink()"><i class="fas fa-share"></i> Share</button>
            </div>
        </div>
    </div>
<script src="config.js"></script>
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
        import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js';
        import { 
            getFirestore, doc, setDoc, getDoc, updateDoc, arrayUnion, arrayRemove,
            collection, query, where, getDocs, onSnapshot, deleteDoc, serverTimestamp
        } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js';

const firebaseConfig = window.CONFIG.firebase;

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let requestsListener = null;

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                loadIncomingRequests();
                setupRequestsListener();
                handleInviteFromUrl();
            } else {
                window.location.href = 'index.html';
            }
        });

        function setupRequestsListener() {
            if (requestsListener) requestsListener();
            
            const userRef = doc(db, 'users', currentUser.uid);
            requestsListener = onSnapshot(userRef, (docSnap) => {
                if (docSnap.exists()) {
                    const userData = docSnap.data();
                    const requests = userData.incomingRequests || [];
                    displayRequests(requests);
                }
            });
        }

        async function loadIncomingRequests() {
            try {
                const userDoc = await getDoc(doc(db, 'users', currentUser.uid));
                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    const requests = userData.incomingRequests || [];
                    displayRequests(requests);
                }
            } catch (error) {
                console.error('Error loading requests:', error);
            }
        }

        function displayRequests(requests) {
            const requestsList = document.getElementById('requestsList');
            const requestCount = document.getElementById('requestCount');
            
            requestCount.textContent = requests.length;
            
            if (requests.length === 0) {
                requestsList.innerHTML = '<div class="no-requests">No pending requests</div>';
                return;
            }
            
            requestsList.innerHTML = requests.map(request => `
                <div class="request-item">
                    <div class="request-avatar">${request.name.charAt(0)}</div>
                    <div class="request-info">
                        <div class="request-name">${request.name}</div>
                        <div class="request-details">${request.age} years • ${request.gender === 'girl' ? 'Female' : 'Male'}${request.isAutoRequest ? ' • Auto Match' : ''}</div>
                    </div>
                    <div class="request-actions">
                        <button class="request-btn accept-btn" onclick="acceptRequest('${request.fromUserId}')">Accept</button>
                        <button class="request-btn decline-btn" onclick="declineRequest('${request.fromUserId}')">Decline</button>
                    </div>
                </div>
            `).join('');
        }

        window.openModal = function(modalId) {
            document.getElementById(modalId).classList.add('show');
        }

        window.closeModal = function(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }

        window.openEmailSearch = function() {
            openModal('emailModal');
        }

        window.searchByEmail = async function() {
            const email = document.getElementById('searchEmail').value.trim();
            
            if (!email || !isValidEmail(email)) {
                showNotification('Please enter a valid email address', 'error');
                return;
            }

            const searchBtn = document.getElementById('searchBtn');
            searchBtn.disabled = true;
            searchBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Searching...';
            
            try {
                const usersQuery = query(collection(db, 'users'), where('email', '==', email));
                const querySnapshot = await getDocs(usersQuery);
                
                if (querySnapshot.empty) {
                    showNotification('User not found. They might not have signed up yet.', 'error');
                    return;
                }

                const targetUserDoc = querySnapshot.docs[0];
                const targetUserData = targetUserDoc.data();
                
                if (targetUserDoc.id === currentUser.uid) {
                    showNotification('You cannot send a request to yourself!', 'error');
                    return;
                }

                const currentUserDoc = await getDoc(doc(db, 'users', currentUser.uid));
                const currentUserData = currentUserDoc.data();

                if (currentUserData.gender === targetUserData.gender) {
                    showNotification('You can only connect with users of opposite gender.', 'error');
                    return;
                }

                if (targetUserData.partnerId && (!targetUserData.partnerData || !targetUserData.partnerData.isBot)) {
                    showNotification('This user already has a partner.', 'error');
                    return;
                }

                const existingRequests = targetUserData.incomingRequests || [];
                if (existingRequests.some(req => req.fromUserId === currentUser.uid)) {
                    showNotification('You have already sent a request to this user.', 'error');
                    return;
                }

                const request = {
                    fromUserId: currentUser.uid,
                    name: currentUserData.name,
                    email: currentUserData.email,
                    gender: currentUserData.gender,
                    age: currentUserData.age,
                    character: currentUserData.character,
                    sentAt: new Date().toISOString()
                };

                await updateDoc(doc(db, 'users', targetUserDoc.id), {
                    incomingRequests: arrayUnion(request)
                });

                showNotification('Request sent successfully!');
                closeModal('emailModal');
                document.getElementById('searchEmail').value = '';

            } catch (error) {
                console.error('Error sending request:', error);
                showNotification('Error sending request. Please try again.', 'error');
            } finally {
                searchBtn.disabled = false;
                searchBtn.innerHTML = '<i class="fas fa-search"></i> Send Request';
            }
        }

        function isValidEmail(email) {
            return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
        }

        window.generateInviteLink = async function() {
            try {
                const currentUserDoc = await getDoc(doc(db, 'users', currentUser.uid));
                const currentUserData = currentUserDoc.data();
                
                const inviteCode = 'inv_' + currentUser.uid + '_' + Date.now();
                
                await updateDoc(doc(db, 'users', currentUser.uid), {
                    inviteCode: inviteCode,
                    inviteCreatedAt: new Date().toISOString()
                });
                
                const inviteLink = `https://ambar0.web.app/index.html?invite=${inviteCode}&from=${encodeURIComponent(currentUserData.name)}`;
                
                document.getElementById('generatedLink').textContent = inviteLink;
                openModal('inviteLinkModal');
            } catch (error) {
                console.error('Error generating invite link:', error);
                showNotification('Error generating invite link.', 'error');
            }
        }

        window.copyInviteLink = function() {
            const linkText = document.getElementById('generatedLink').textContent;
            
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(linkText).then(() => {
                    showCopySuccess();
                });
            } else {
                const textArea = document.createElement('textarea');
                textArea.value = linkText;
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    showCopySuccess();
                } catch (err) {
                    showNotification('Failed to copy. Please copy manually.', 'error');
                }
                document.body.removeChild(textArea);
            }
        }

        function showCopySuccess() {
            const copyBtn = document.querySelector('.copy-btn');
            const originalText = copyBtn.innerHTML;
            copyBtn.innerHTML = '<i class="fas fa-check"></i> Copied!';
            copyBtn.style.background = 'linear-gradient(45deg, #4CAF50, #45a049)';
            
            setTimeout(() => {
                copyBtn.innerHTML = originalText;
                copyBtn.style.background = 'linear-gradient(45deg, #4285f4, #34a853)';
            }, 2000);
        }

        window.shareInviteLink = function() {
            const linkText = document.getElementById('generatedLink').textContent;
            const shareText = `Join me on Ambar! ${linkText}`;
            
            if (navigator.share) {
                navigator.share({
                    title: 'Join me on Ambar',
                    text: shareText,
                    url: linkText
                });
            } else {
                copyInviteLink();
                showNotification('Link copied! You can now paste it anywhere.');
            }
        }

        window.acceptRequest = async function(fromUserId) {
            try {
                const currentUserDoc = await getDoc(doc(db, 'users', currentUser.uid));
                const currentUserData = currentUserDoc.data();
                const senderDoc = await getDoc(doc(db, 'users', fromUserId));
                
                if (!senderDoc.exists()) {
                    showNotification('User not found.', 'error');
                    return;
                }
                
                const senderData = senderDoc.data();

                if (senderData.partnerId && (!senderData.partnerData || !senderData.partnerData.isBot)) {
                    showNotification('This user already has a partner.', 'error');
                    return;
                }

                // Remove bot partners if they exist
                if (currentUserData.partnerId && currentUserData.partnerData && currentUserData.partnerData.isBot) {
                    await deleteDoc(doc(db, 'users', currentUserData.partnerId));
                }

                if (senderData.partnerId && senderData.partnerData && senderData.partnerData.isBot) {
                    await deleteDoc(doc(db, 'users', senderData.partnerId));
                }

                const requestToRemove = currentUserData.incomingRequests.find(req => req.fromUserId === fromUserId);
                
                // Update current user
                await updateDoc(doc(db, 'users', currentUser.uid), {
                    partnerId: fromUserId,
                    partnerData: {
                        id: fromUserId,
                        name: senderData.name,
                        gender: senderData.gender,
                        age: senderData.age,
                        character: senderData.character,
                        isBot: false
                    },
                    partnershipStarted: serverTimestamp(),
                    incomingRequests: arrayRemove(requestToRemove)
                });

                // Update sender
                await updateDoc(doc(db, 'users', fromUserId), {
                    partnerId: currentUser.uid,
                    partnerData: {
                        id: currentUser.uid,
                        name: currentUserData.name,
                        gender: currentUserData.gender,
                        age: currentUserData.age,
                        character: currentUserData.character,
                        isBot: false
                    },
                    partnershipStarted: serverTimestamp()
                });

                showNotification(`You are now connected with ${senderData.name}!`);
                
                setTimeout(() => {
                    window.location.href = 'home.html';
                }, 1500);

            } catch (error) {
                console.error('Error accepting request:', error);
                showNotification('Error accepting request.', 'error');
            }
        }

        window.declineRequest = async function(fromUserId) {
            try {
                const currentUserDoc = await getDoc(doc(db, 'users', currentUser.uid));
                const currentUserData = currentUserDoc.data();
                
                const requestToRemove = currentUserData.incomingRequests.find(req => req.fromUserId === fromUserId);
                
                await updateDoc(doc(db, 'users', currentUser.uid), {
                    incomingRequests: arrayRemove(requestToRemove)
                });

                showNotification('Request declined.');
                
            } catch (error) {
                console.error('Error declining request:', error);
                showNotification('Error declining request.', 'error');
            }
        }

        async function handleInviteFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            const inviteCode = urlParams.get('invite');
            const fromUser = urlParams.get('from');
            
            if (inviteCode && fromUser && currentUser) {
                try {
                    const usersQuery = query(collection(db, 'users'), where('inviteCode', '==', inviteCode));
                    const querySnapshot = await getDocs(usersQuery);
                    
                    if (querySnapshot.empty) {
                        showNotification('Invalid or expired invite link.', 'error');
                        return;
                    }

                    const senderDoc = querySnapshot.docs[0];
                    const senderData = senderDoc.data();
                    const currentUserDoc = await getDoc(doc(db, 'users', currentUser.uid));
                    const currentUserData = currentUserDoc.data();

                    if (senderDoc.id === currentUser.uid) {
                        showNotification('You cannot use your own invite link!', 'error');
                        return;
                    }

                    if (currentUserData.gender === senderData.gender) {
                        showNotification('You can only connect with users of opposite gender.', 'error');
                        return;
                    }

                    if (senderData.partnerId && (!senderData.partnerData || !senderData.partnerData.isBot)) {
                        showNotification('This user already has a partner.', 'error');
                        return;
                    }

                    if (currentUserData.partnerId && (!currentUserData.partnerData || !currentUserData.partnerData.isBot)) {
                        showNotification('You already have a partner.', 'error');
                        return;
                    }

                    // Remove bot partners
                    if (currentUserData.partnerId && currentUserData.partnerData && currentUserData.partnerData.isBot) {
                        await deleteDoc(doc(db, 'users', currentUserData.partnerId));
                    }

                    if (senderData.partnerId && senderData.partnerData && senderData.partnerData.isBot) {
                        await deleteDoc(doc(db, 'users', senderData.partnerId));
                    }

                    // Auto-connect
                    await updateDoc(doc(db, 'users', currentUser.uid), {
                        partnerId: senderDoc.id,
                        partnerData: {
                            id: senderDoc.id,
                            name: senderData.name,
                            gender: senderData.gender,
                            age: senderData.age,
                            character: senderData.character,
                            isBot: false
                        },
                        partnershipStarted: serverTimestamp()
                    });

                    await updateDoc(doc(db, 'users', senderDoc.id), {
                        partnerId: currentUser.uid,
                        partnerData: {
                            id: currentUser.uid,
                            name: currentUserData.name,
                            gender: currentUserData.gender,
                            age: currentUserData.age,
                            character: currentUserData.character,
                            isBot: false
                        },
                        partnershipStarted: serverTimestamp()
                    });

                    showNotification(`Welcome! You are now connected with ${senderData.name}!`);
                    
                    setTimeout(() => {
                        window.location.href = 'home.html';
                    }, 2000);

                } catch (error) {
                    console.error('Error handling invite:', error);
                    showNotification('Error processing invite link.', 'error');
                }
            }
        }

        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type === 'error' ? 'error' : ''}`;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => notification.classList.add('show'), 100);
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => document.body.removeChild(notification), 300);
            }, 3000);
        }

        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('modal')) {
                e.target.classList.remove('show');
            }
        });

        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                document.querySelectorAll('.modal.show').forEach(modal => {
                    modal.classList.remove('show');
                });
            }
        });
    </script>
</body>
</html>