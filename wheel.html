<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lucky Wheel Game - Ambar</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&display=swap" rel="stylesheet">

        <link rel="stylesheet" href="style/tool.css">   
        <link rel="stylesheet" href="style/wheel.css">

</head>
<body>
    
    <div class="game-container">
        <div class="betting-section" id="betting-section">
            <h2 class="betting-title">Place Your Bet</h2>
            <div class="bet-options">
                <button class="bet-btn" data-bet="20">20</button>
                <button class="bet-btn" data-bet="50">50</button>
                <button class="bet-btn" data-bet="100">100</button>
                <button class="bet-btn" data-bet="200">200</button>
                <button class="bet-btn" data-bet="500">500</button>
                <button class="bet-btn" id="all-in-btn">All In</button>
            </div>
            <div class="custom-bet">
                <input type="number" id="custom-bet-input" placeholder="Custom amount" min="1">
            </div>
            <button class="start-game-btn" id="start-game-btn">Start Game</button>
        </div>
        
        <div class="game-area" id="game-area">
            <div class="round-info">
                <div class="bet-display">Current Bet: <span id="current-bet">0</span> coins</div>
                <div class="progress-section">
                    <div>Win Rate: <span id="win-rate">0%</span></div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progress-fill"></div>
                    </div>
                </div>
            </div>
            
            <div class="status-message" id="status-message">Click the button to spin the wheel!</div>
            
            <div class="wheel-container">
                <div class="wheel-pointer"></div>
                <div class="wheel" id="wheel">
                    <div class="wheel-segments">
                        <div class="segment-label segment-0">5x</div>
                        <div class="segment-label segment-1">0.5x</div>
                        <div class="segment-label segment-2">2x</div>
                        <div class="segment-label segment-3">0x</div>
                        <div class="segment-label segment-4">10x</div>
                        <div class="segment-label segment-5">1x</div>
                        <div class="segment-label segment-6">3x</div>
                        <div class="segment-label segment-7">0.2x</div>
                    </div>
                </div>
                <div class="wheel-center">
                    <i class="fas fa-star"></i>
                </div>
            </div>
            
            <button class="spin-btn" id="spin-btn">SPIN THE WHEEL!</button>
            
            <div class="prize-legend">
                <div class="legend-item">
                    <div class="legend-color" style="background: #FF4444;"></div>
                    <div class="legend-text">5x Multiplier</div>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #44FF44;"></div>
                    <div class="legend-text">0.5x Multiplier</div>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #4444FF;"></div>
                    <div class="legend-text">2x Multiplier</div>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #FFFF44;"></div>
                    <div class="legend-text">0x (Lose All)</div>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #FF44FF;"></div>
                    <div class="legend-text">10x Multiplier</div>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #44FFFF;"></div>
                    <div class="legend-text">1x (Break Even)</div>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #FFA500;"></div>
                    <div class="legend-text">3x Multiplier</div>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #A0A0A0;"></div>
                    <div class="legend-text">0.2x Multiplier</div>
                </div>
            </div>
        </div>
        
        <div class="result-popup" id="result-popup">
            <div class="popup-content">
                <h2 class="result-title" id="result-title">Round Complete!</h2>
                <div class="result-amount" id="result-amount">+0 coins</div>
                <div class="result-details" id="result-details"></div>
                <button class="next-game-btn" id="next-game-btn">Play Again</button>
            </div>
        </div>
    </div>
    
    <script src="tool.js"></script>
    <script>
        class LuckyWheelGame {
            constructor() {
                this.currentBet = 0;
                this.gameInProgress = false;
                this.gamesPlayed = 0;
                this.gamesWon = 0;
                this.isSpinning = false;
                
                this.segments = [
                    { multiplier: 5, probability: 0.05 },      // 5%
                    { multiplier: 0.5, probability: 0.20 },   // 20%
                    { multiplier: 2, probability: 0.15 },     // 15%
                    { multiplier: 0, probability: 0.10 },     // 10%
                    { multiplier: 10, probability: 0.02 },    // 2%
                    { multiplier: 1, probability: 0.25 },     // 25%
                    { multiplier: 3, probability: 0.10 },     // 10%
                    { multiplier: 0.2, probability: 0.13 }    // 13%
                ];
                
                this.initializeEventListeners();
                this.updateDisplay();
            }
            
            initializeEventListeners() {
                // Bet buttons
                document.querySelectorAll('.bet-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        document.querySelectorAll('.bet-btn').forEach(b => b.classList.remove('selected'));
                        btn.classList.add('selected');
                        
                        if (btn.id === 'all-in-btn') {
                            this.currentBet = AmbarHeader.getCurrency('coins');
                            document.getElementById('custom-bet-input').value = this.currentBet;
                        } else {
                            this.currentBet = parseInt(btn.dataset.bet);
                            document.getElementById('custom-bet-input').value = this.currentBet;
                        }
                        
                        this.validateBet();
                    });
                });
                
                // Custom bet input
                const customBetInput = document.getElementById('custom-bet-input');
                customBetInput.addEventListener('input', (e) => {
                    const value = parseInt(e.target.value) || 0;
                    this.currentBet = value;
                    document.querySelectorAll('.bet-btn').forEach(b => b.classList.remove('selected'));
                    this.validateBet();
                });
                
                // Start game button
                document.getElementById('start-game-btn').addEventListener('click', () => {
                    this.startGame();
                });
                
                // Spin button
                document.getElementById('spin-btn').addEventListener('click', () => {
                    this.spinWheel();
                });
                
                // Next game button
                document.getElementById('next-game-btn').addEventListener('click', () => {
                    this.nextGame();
                });
                
                // Close popup on outside click
                document.getElementById('result-popup').addEventListener('click', (e) => {
                    if (e.target === e.currentTarget) {
                        this.nextGame();
                    }
                });
            }
            
            updateDisplay() {
                const allInBtn = document.getElementById('all-in-btn');
                if (allInBtn) {
                    allInBtn.textContent = `All In (${AmbarHeader.getCurrency('coins')})`;
                }
            }
            
            validateBet() {
                const startBtn = document.getElementById('start-game-btn');
                const playerCoins = AmbarHeader.getCurrency('coins');
                const isValid = this.currentBet > 0 && this.currentBet <= playerCoins;
                
                startBtn.disabled = !isValid;
                startBtn.textContent = isValid ? 'Start Game' : 
                    (this.currentBet > playerCoins ? 'Insufficient Coins' : 'Enter Bet Amount');
            }
            
            startGame() {
                if (this.currentBet <= 0 || this.currentBet > AmbarHeader.getCurrency('coins') || this.gameInProgress) return;
                
                this.gameInProgress = true;
                AmbarHeader.updateCurrency('coins', -this.currentBet);
                
                document.getElementById('betting-section').style.display = 'none';
                document.getElementById('game-area').style.display = 'block';
                document.getElementById('current-bet').textContent = this.currentBet.toLocaleString();
                
                this.resetGame();
                this.updateProgressDisplay();
            }
            
            resetGame() {
                const wheel = document.getElementById('wheel');
                wheel.style.transform = 'rotate(0deg)';
                this.isSpinning = false;
                document.getElementById('spin-btn').disabled = false;
                document.getElementById('status-message').textContent = 'Click the button to spin the wheel!';
            }
            
            updateProgressDisplay() {
                const winRate = this.gamesPlayed > 0 ? Math.round((this.gamesWon / this.gamesPlayed) * 100) : 0;
                document.getElementById('win-rate').textContent = `${winRate}%`;
                document.getElementById('progress-fill').style.width = `${winRate}%`;
            }
            
            spinWheel() {
                if (this.isSpinning) return;
                
                this.isSpinning = true;
                const spinBtn = document.getElementById('spin-btn');
                spinBtn.disabled = true;
                
                document.getElementById('status-message').textContent = 'Spinning...';
                
                // Weighted random selection
                const selectedSegment = this.getWeightedRandomSegment();
                
                // Calculate rotation (each segment is 45 degrees, starting from top)
                const segmentAngle = 45;
                const baseRotation = selectedSegment * segmentAngle;
                
                // Add extra rotations for effect (3-5 full rotations)
                const extraRotations = (3 + Math.random() * 2) * 360;
                const finalRotation = extraRotations + baseRotation;
                
                const wheel = document.getElementById('wheel');
                wheel.style.transform = `rotate(${finalRotation}deg)`;
                
                // Wait for animation to complete
                setTimeout(() => {
                    this.handleSpinResult(selectedSegment);
                }, 4000);
            }
            
            getWeightedRandomSegment() {
                const random = Math.random();
                let cumulativeProbability = 0;
                
                for (let i = 0; i < this.segments.length; i++) {
                    cumulativeProbability += this.segments[i].probability;
                    if (random <= cumulativeProbability) {
                        return i;
                    }
                }
                
                // Fallback to last segment
                return this.segments.length - 1;
            }
            
            handleSpinResult(segmentIndex) {
                const segment = this.segments[segmentIndex];
                const multiplier = segment.multiplier;
                const reward = Math.round(multiplier * this.currentBet);
                const netResult = reward - this.currentBet;
                
                this.gamesPlayed++;
                if (netResult >= 0) this.gamesWon++;
                
                // Update currencies
                AmbarHeader.updateCurrency('coins', reward);
                
                // Update game stats
                const winPercentage = netResult >= 0 ? 100 : 0;
                this.updateGameStats(winPercentage, netResult);
                
                document.getElementById('status-message').textContent = `You landed on ${multiplier}x!`;
                
                setTimeout(() => {
                    this.showResults(netResult, multiplier, reward, segmentIndex);
                }, 1500);
                
                this.isSpinning = false;
                this.gameInProgress = false;
            }
            
            updateGameStats(winPercentage, coinsEarned) {
                // Update localStorage stats for game.html integration
                const currentGames = parseInt(localStorage.getItem('luckGamesPlayed') || '0') + 1;
                const currentCoins = parseInt(localStorage.getItem('luckCoinsEarned') || '0') + coinsEarned;
                const currentWinRate = parseFloat(localStorage.getItem('totalWinRate') || '0');
                
                const newWinRate = currentGames > 0 ? 
                    ((currentWinRate * (currentGames - 1)) + winPercentage) / currentGames : winPercentage;
                
                localStorage.setItem('luckGamesPlayed', currentGames);
                localStorage.setItem('luckCoinsEarned', currentCoins);
                localStorage.setItem('totalWinRate', newWinRate);
                localStorage.setItem('luck', Math.round(newWinRate));
            }
            
            showResults(netResult, multiplier, reward, segmentIndex) {
                const popup = document.getElementById('result-popup');
                const title = document.getElementById('result-title');
                const amount = document.getElementById('result-amount');
                const details = document.getElementById('result-details');
                
                if (netResult > 0) {
                    title.textContent = 'You Won!';
                    amount.textContent = `+${netResult.toLocaleString()} coins`;
                    amount.className = 'result-amount positive';
                } else if (netResult < 0) {
                    title.textContent = 'You Lost';
                    amount.textContent = `${netResult.toLocaleString()} coins`;
                    amount.className = 'result-amount negative';
                } else {
                    title.textContent = 'Break Even';
                    amount.textContent = `±0 coins`;
                    amount.className = 'result-amount';
                }
                
                const segmentNames = ['5x Red', '0.5x Green', '2x Blue', '0x Yellow', '10x Purple', '1x Cyan', '3x Orange', '0.2x Gray'];
                
                details.innerHTML = `
                    <p><strong>Wheel Result:</strong> ${segmentNames[segmentIndex]}</p>
                    <p><strong>Multiplier:</strong> ${multiplier}x</p>
                    <p><strong>Bet:</strong> ${this.currentBet.toLocaleString()} | <strong>Reward:</strong> ${reward.toLocaleString()}</p>
                `;
                
                popup.style.display = 'flex';
            }
            
            nextGame() {
                document.getElementById('result-popup').style.display = 'none';
                document.getElementById('game-area').style.display = 'none';
                document.getElementById('betting-section').style.display = 'block';
                
                // Reset bet selection
                document.querySelectorAll('.bet-btn').forEach(b => b.classList.remove('selected'));
                document.getElementById('custom-bet-input').value = '';
                this.currentBet = 0;
                this.updateDisplay();
                this.validateBet();
                
                // Check if player has enough coins for minimum bet
                if (AmbarHeader.getCurrency('coins') < 20) {
                    this.showGameOverModal();
                }
            }
            
            showGameOverModal() {
                const popup = document.getElementById('result-popup');
                const title = document.getElementById('result-title');
                const amount = document.getElementById('result-amount');
                const details = document.getElementById('result-details');
                const nextBtn = document.getElementById('next-game-btn');
                
                title.textContent = 'Game Over!';
                amount.textContent = 'Insufficient Coins';
                amount.className = 'result-amount negative';
                details.innerHTML = `
                    <p>You need at least 20 coins to play Lucky Wheel.</p>
                    <p>Visit the store or play other games to earn more coins!</p>
                `;
                nextBtn.textContent = 'Go Back';
                
                popup.style.display = 'flex';
                
                nextBtn.onclick = () => {
                    AmbarNavigation.navigateTo('games');
                };
            }
        }
        
        // Initialize game when page loads
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize header with back button
            AmbarHeader.init({
                showCurrencies: ['coins', 'luck'],
                showSettings: false,
                showBackButton: true
            });
            
            // Override back button to go to games page
            AmbarHeader.goBack = () => {
                AmbarNavigation.navigateTo('games');
            };
            
            AmbarNavigation.setActivePage('games');
            
            new LuckyWheelGame();
        });
    </script>
</body>
</html>